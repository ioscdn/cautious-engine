name: Check RSS for new content

on:
    push:
        branches:
            - main
    workflow_dispatch:
    schedule:
        - cron: "*/10 * * * *"

concurrency:
    group: check-rss

env:
    RCLONE_CONFIG: ${{ secrets.RCLONE_CONFIG }}
    RCLONE_CONFIG_PATH: rclone.conf
    RCLONE_DEST: ${{ secrets.RCLONE_DEST }}
    RSS_URL: ${{ secrets.RSS_URL }}
    HTTP_URL: ${{ secrets.HTTP_URL }}
    LAST_CHECKED_ON: ${{ secrets.LAST_CHECKED_ON || vars.LAST_CHECKED_ON }}
    RETRY_FOR_MINUTES: ${{ secrets.RETRY_FOR_MINUTES || vars.RETRY_FOR_MINUTES }}

jobs:
    check-rss-for-new-content:
        runs-on: ubuntu-22.04
        steps:
            - name: Checkout Repo
              uses: actions/checkout@v3

            - name: Setup Python
              uses: actions/setup-python@v4

            - name: Setup Rclone
              run: |
                  sudo -v ; curl https://rclone.org/install.sh | sudo bash
                  echo "$RCLONE_CONFIG" > $RCLONE_CONFIG_PATH

            - name: Install requirements
              run: |
                  pip install -r requirements.txt

            - name: Download artifact
              uses: dawidd6/action-download-artifact@v2
              with:
                  name: rss-data
                  github_token: ${{secrets.GITHUB_TOKEN}}
                  workflow_conclusion: success
                  if_no_artifact_found: warn

            - name: Run check script
              timeout-minutes: 330
              run: |
                  python3 main.py

            - name: Upload artifacts
              if: '!cancelled()'
              uses: actions/upload-artifact@v3
              with:
                  name: rss-data
                  path: rss-data.json
